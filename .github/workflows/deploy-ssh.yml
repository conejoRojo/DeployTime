name: Deploy cPanel SSH
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          
      - name: Install Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Copy files via SSH
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "."
          target: "/home/${{ secrets.SSH_USERNAME }}/deploytime_core"
          rm: false # No borrar carpetas existentes como storage
          
      - name: Execute Remote Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
             cd /home/${{ secrets.SSH_USERNAME }}/deploytime_core
             # Activar modo mantenimiento (opcional)
             # php artisan down
             
             # Migraciones y optimizaci√≥n
             php artisan migrate --force
             php artisan config:cache
             php artisan route:cache
             php artisan view:cache
             
             # Desactivar modo mantenimiento
             # php artisan up
