name: Security Scan (SAST + SCA + Secrets)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write
  actions: read

jobs:
  # Job 1: SAST con Semgrep - CORREGIDO
  semgrep-sast:
    name: SAST - Semgrep (PHP + JavaScript)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ejecutar Semgrep SAST
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/owasp-top-ten
            p/php
            p/javascript
            p/react
            p/sql-injection
            p/xss
            p/security-audit
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Subir resultados SARIF a GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif
          category: semgrep

  # Job 2: SCA con Trivy
  trivy-sca:
    name: SCA - Trivy (Dependencias + Docker)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Escanear dependencias PHP (Composer)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: './backend'
          format: 'sarif'
          output: 'trivy-php.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Subir resultados PHP a Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-php.sarif
          category: trivy-php

      - name: Escanear dependencias Node.js (npm)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: './desktop'
          format: 'sarif'
          output: 'trivy-node.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Subir resultados Node.js a Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-node.sarif
          category: trivy-node

      - name: Escanear configuracion Docker
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-docker.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Subir resultados Docker a Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-docker.sarif
          category: trivy-docker

  # Job 3: Deteccion de Secretos - SOLUCION GITHUB
  detect-secrets:
    name: Deteccion de Secretos Hardcodeados
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Instalar dependencias
        run: |
          pip install detect-secrets
          sudo apt-get update && sudo apt-get install -y jq

      - name: Escanear secretos en el codigo
        run: |
          if [ -f ".secrets.baseline" ]; then
            echo "‚úì Usando baseline existente para detectar solo secretos nuevos"
            detect-secrets scan --baseline .secrets.baseline --all-files > .secrets.baseline.new || true
            mv .secrets.baseline.new .secrets.baseline
          else
            echo "‚ö†Ô∏è Generando baseline inicial de secretos"
            detect-secrets scan --all-files \
              --exclude-files '\.lock$' \
              --exclude-files 'node_modules/' \
              --exclude-files 'vendor/' \
              --exclude-files '\.git/' \
              --exclude-files 'package-lock\.json' \
              --exclude-files 'composer\.lock' \
              --exclude-files '\.min\.js$' \
              --exclude-files '\.svg$' \
              --exclude-files 'public/assets/' \
              --exclude-files 'storage/' \
              --exclude-files 'dist/' \
              --exclude-files 'build/' \
              --exclude-files '\.map$' \
              > .secrets.baseline
            echo "BASELINE_CREATED=true" >> $GITHUB_ENV
            echo "::warning::Baseline inicial generada. Audite localmente: python -m detect_secrets audit .secrets.baseline"
          fi

      - name: Verificar resultados
        id: check_secrets
        run: |
          SECRET_COUNT=$(jq '.results | to_entries | map(.value | length) | add // 0' .secrets.baseline)
          echo "secrets_found=$SECRET_COUNT" >> $GITHUB_OUTPUT
          
          if [ "${BASELINE_CREATED}" = "true" ]; then
            echo "‚úì Baseline inicial creada con $SECRET_COUNT hallazgos"
            echo "  No falla en primera ejecuci√≥n"
            exit 0
          fi
          
          if [ "$SECRET_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è Se encontraron $SECRET_COUNT secretos potenciales"
            exit 1
          else
            echo "‚úì No se encontraron secretos nuevos"
          fi

  # Job 4: Resumen de Seguridad
  security-summary:
    name: Resumen de Seguridad
    runs-on: ubuntu-latest
    needs: [semgrep-sast, trivy-sca, detect-secrets]
    if: always()
    
    steps:
      - name: Generar resumen
        uses: actions/github-script@v7
        with:
          script: |
            const semgrep = '${{ needs.semgrep-sast.result }}';
            const trivy = '${{ needs.trivy-sca.result }}';
            const secrets = '${{ needs.detect-secrets.result }}';
            
            let summary = '# üîí Resumen de An√°lisis de Seguridad\n\n';
            summary += '| Herramienta | Estado | Descripci√≥n |\n';
            summary += '|-------------|--------|-------------|\n';
            
            const statusIcon = (status) => {
              if (status === 'success') return '‚úÖ';
              if (status === 'failure') return '‚ùå';
              return '‚ö†Ô∏è';
            };
            
            const statusText = (status) => {
              if (status === 'success') return 'Pas√≥';
              if (status === 'failure') return 'Fall√≥';
              return 'Advertencia';
            };
            
            summary += `| ${statusIcon(semgrep)} Semgrep SAST | ${statusText(semgrep)} | An√°lisis est√°tico (PHP + JS) |\n`;
            summary += `| ${statusIcon(trivy)} Trivy SCA | ${statusText(trivy)} | An√°lisis de dependencias |\n`;
            summary += `| ${statusIcon(secrets)} detect-secrets | ${statusText(secrets)} | Detecci√≥n de secretos |\n\n`;
            
            if (semgrep === 'success' && trivy === 'success' && secrets === 'success') {
              summary += '## ‚úÖ Pipeline Completamente Funcional\n\n';
              summary += 'Todas las herramientas ejecutadas exitosamente.\n\n';
              summary += '**Pr√≥ximos pasos:**\n';
              summary += '- Revisar alertas en Security tab\n';
              summary += '- Priorizar vulnerabilidades CRITICAL/HIGH\n';
              summary += '- Actualizar dependencias seg√∫n sea necesario\n';
            } else {
              summary += '## Estado del Pipeline\n\n';
              if (semgrep !== 'success') {
                summary += '- **Semgrep:** Revisar configuraci√≥n o resultados\n';
              }
              if (trivy !== 'success') {
                summary += '- **Trivy:** Revisar vulnerabilidades detectadas\n';
              }
              if (secrets !== 'success') {
                summary += '- **Secrets:** Auditar baseline localmente\n';
              }
            }
            
            summary += '\n---\n\n';
            summary += '**üìä Configuraci√≥n del Pipeline:**\n';
            summary += '- Herramientas: Semgrep (SAST), Trivy (SCA), detect-secrets\n';
            summary += '- Costo: $0 (GitHub Actions + herramientas OSS)\n';
            summary += '- Tiempo: 4-6 minutos por ejecuci√≥n\n';
            summary += '- Cobertura: 100% de commits en main/develop\n';
            
            await core.summary
              .addRaw(summary)
              .write();