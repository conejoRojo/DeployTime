name: Security Scan (SAST + SCA + Secrets)

# Cu√°ndo se ejecuta este workflow
on:
  # En Pull Requests hacia develop o main
  pull_request:
    branches:
      - main
      - develop
  # En push directo a develop o main (√∫ltima l√≠nea de defensa)
  push:
    branches:
      - main
      - develop
  # Permitir ejecuci√≥n manual desde GitHub UI
  workflow_dispatch:

# Permisos necesarios para el workflow
permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # Job 1: SAST con Semgrep
  semgrep-sast:
    name: SAST - Semgrep (PHP + JavaScript)
    runs-on: ubuntu-latest
    
    steps:
      # Descargar c√≥digo del repositorio
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para an√°lisis completo

      # Ejecutar Semgrep
      - name: Ejecutar Semgrep SAST
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/owasp-top-ten
            p/php
            p/laravel
            p/javascript
            p/react
            p/sql-injection
            p/xss
            p/security-audit
          # Genera reporte JSON para an√°lisis
          generateSarif: true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      
      # Subir resultados a GitHub Security
      - name: Subir resultados SARIF a GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
      
      # Comentar en el PR si hay vulnerabilidades
      - name: Comentar resultados en PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const sarif = JSON.parse(fs.readFileSync('semgrep.sarif', 'utf8'));
              const results = sarif.runs[0].results || [];
              
              if (results.length > 0) {
                let comment = '## üîç Semgrep SAST - Vulnerabilidades Detectadas\n\n';
                comment += `**Total de issues encontrados: ${results.length}**\n\n`;
                
                // Agrupar por severidad
                const critical = results.filter(r => r.level === 'error');
                const warnings = results.filter(r => r.level === 'warning');
                const notes = results.filter(r => r.level === 'note');
                
                if (critical.length > 0) {
                  comment += `### ‚ùå Cr√≠ticos: ${critical.length}\n`;
                  critical.slice(0, 5).forEach(r => {
                    comment += `- **${r.ruleId}**: ${r.message.text}\n`;
                    comment += `  üìç ${r.locations[0].physicalLocation.artifactLocation.uri}:${r.locations[0].physicalLocation.region.startLine}\n\n`;
                  });
                }
                
                if (warnings.length > 0) {
                  comment += `### ‚ö†Ô∏è Advertencias: ${warnings.length}\n`;
                }
                
                if (notes.length > 0) {
                  comment += `### ‚ÑπÔ∏è Informativas: ${notes.length}\n`;
                }
                
                comment += '\nVer detalles completos en la pesta√±a **Security** del repositorio.';
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              } else {
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: '## ‚úÖ Semgrep SAST - Sin Vulnerabilidades\n\nNo se detectaron vulnerabilidades de seguridad en el c√≥digo.'
                });
              }
            } catch (error) {
              console.log('No se pudo procesar el reporte SARIF:', error);
            }

  # Job 2: SCA con Trivy (dependencias y contenedores)
  trivy-sca:
    name: SCA - Trivy (Dependencias + Docker)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      # Escanear dependencias PHP (composer.lock)
      - name: Escanear dependencias PHP (composer)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './backend'
          format: 'sarif'
          output: 'trivy-php-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln'
      
      # Escanear dependencias Node.js (package-lock.json)
      - name: Escanear dependencias Node.js (npm)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './desktop'
          format: 'sarif'
          output: 'trivy-node-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln'
      
      # Escanear imagen Docker si existe
      - name: Escanear imagen Docker
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: './backend/Dockerfile.dev'
          format: 'sarif'
          output: 'trivy-docker-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
      
      # Subir resultados PHP a GitHub Security
      - name: Subir resultados PHP a GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-php-results.sarif'
          category: 'trivy-php'
      
      # Subir resultados Node.js a GitHub Security
      - name: Subir resultados Node.js a GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-node-results.sarif'
          category: 'trivy-node'
      
      # Subir resultados Docker a GitHub Security
      - name: Subir resultados Docker a GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-docker-results.sarif'
          category: 'trivy-docker'
      
      # Generar reporte en formato tabla para PR
      - name: Generar reporte de vulnerabilidades
        if: github.event_name == 'pull_request'
        run: |
          echo "## üì¶ Trivy SCA - An√°lisis de Dependencias" > trivy-report.md
          echo "" >> trivy-report.md
          
          # Backend PHP
          echo "### Backend (PHP/Laravel)" >> trivy-report.md
          trivy fs --format table --severity CRITICAL,HIGH,MEDIUM ./backend >> trivy-report.md 2>&1 || echo "Sin vulnerabilidades cr√≠ticas en backend" >> trivy-report.md
          echo "" >> trivy-report.md
          
          # Desktop Node.js
          echo "### Desktop (Node.js/Electron)" >> trivy-report.md
          trivy fs --format table --severity CRITICAL,HIGH,MEDIUM ./desktop >> trivy-report.md 2>&1 || echo "Sin vulnerabilidades cr√≠ticas en desktop" >> trivy-report.md
          
      # Comentar en PR
      - name: Comentar resultados en PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('trivy-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # Job 3: Detecci√≥n de Secretos con detect-secrets
  detect-secrets:
    name: Detecci√≥n de Secretos Hardcodeados
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para analizar historial
      
      # Instalar detect-secrets
      - name: Instalar detect-secrets
        run: |
          pip install detect-secrets
      
      # Escanear repositorio completo
      - name: Escanear secretos en el c√≥digo
        run: |
          detect-secrets scan --all-files \
            --exclude-files '\.lock$' \
            --exclude-files 'node_modules/' \
            --exclude-files 'vendor/' \
            --exclude-files '\.git/' \
            --exclude-files 'package-lock\.json' \
            --exclude-files 'composer\.lock' \
            > .secrets.baseline
      
      # Verificar si hay secretos detectados
      - name: Verificar resultados
        id: check_secrets
        run: |
          # Contar secretos encontrados
          SECRET_COUNT=$(jq '.results | to_entries | map(.value | length) | add // 0' .secrets.baseline)
          echo "secrets_found=$SECRET_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$SECRET_COUNT" -gt 0 ]; then
            echo "‚ùå Se encontraron $SECRET_COUNT secretos potenciales"
            exit 1
          else
            echo "‚úÖ No se encontraron secretos hardcodeados"
          fi
      
      # Comentar en PR si hay secretos
      - name: Comentar secretos en PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const baseline = JSON.parse(fs.readFileSync('.secrets.baseline', 'utf8'));
            
            let comment = '## üîê detect-secrets - Secretos Detectados\n\n';
            comment += '‚ö†Ô∏è **Se detectaron secretos potenciales hardcodeados en el c√≥digo.**\n\n';
            
            for (const [file, secrets] of Object.entries(baseline.results)) {
              if (secrets.length > 0) {
                comment += `### üìÑ ${file}\n`;
                secrets.forEach(secret => {
                  comment += `- **L√≠nea ${secret.line_number}**: ${secret.type}\n`;
                });
                comment += '\n';
              }
            }
            
            comment += '### ‚úÖ Acciones Requeridas\n';
            comment += '1. Remover los secretos del c√≥digo\n';
            comment += '2. Usar variables de entorno (.env)\n';
            comment += '3. Usar GitHub Secrets para CI/CD\n';
            comment += '4. Si es un falso positivo, agregar a .secrets.baseline\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      # Comentar √©xito en PR
      - name: Comentar √©xito en PR
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ‚úÖ detect-secrets - Sin Secretos Hardcodeados\n\nNo se detectaron secretos hardcodeados en el c√≥digo.'
            });

  # Job 4: Resumen Final
  security-summary:
    name: Resumen de Seguridad
    runs-on: ubuntu-latest
    needs: [semgrep-sast, trivy-sca, detect-secrets]
    if: always()
    
    steps:
      - name: Generar resumen
        uses: actions/github-script@v7
        with:
          script: |
            const semgrep = '${{ needs.semgrep-sast.result }}';
            const trivy = '${{ needs.trivy-sca.result }}';
            const secrets = '${{ needs.detect-secrets.result }}';
            
            let summary = '# üõ°Ô∏è Resumen de An√°lisis de Seguridad\n\n';
            summary += '| Herramienta | Estado | Descripci√≥n |\n';
            summary += '|-------------|--------|-------------|\n';
            
            const statusIcon = (status) => {
              if (status === 'success') return '‚úÖ';
              if (status === 'failure') return '‚ùå';
              return '‚ö†Ô∏è';
            };
            
            summary += `| ${statusIcon(semgrep)} Semgrep SAST | ${semgrep} | An√°lisis est√°tico de c√≥digo |\n`;
            summary += `| ${statusIcon(trivy)} Trivy SCA | ${trivy} | An√°lisis de dependencias |\n`;
            summary += `| ${statusIcon(secrets)} detect-secrets | ${secrets} | Detecci√≥n de secretos |\n\n`;
            
            if (semgrep === 'success' && trivy === 'success' && secrets === 'success') {
              summary += '## ‚úÖ Todos los Checks Pasaron\n\n';
              summary += 'El c√≥digo cumple con los est√°ndares de seguridad establecidos.';
            } else {
              summary += '## ‚ö†Ô∏è Acci√≥n Requerida\n\n';
              summary += 'Se detectaron problemas de seguridad que deben ser resueltos antes del merge.';
            }
            
            await core.summary
              .addRaw(summary)
              .write();